<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>tjr_lin_partition.ml</title>
<meta name="generator" content="emacs 26.1; htmlfontify 0.21" />
<style type="text/css"><!-- 
body { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #000000;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.default   { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #000000;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.default a { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #000000;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.merlin-compilation-error-face-0000   { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.merlin-compilation-error-face-0000 a { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.label   { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.label a { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.attribute   { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.attribute a { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.tuareg-font-double-colon-face   { color: #ff4500;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.tuareg-font-double-colon-face a { color: #ff4500;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.string   { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.string a { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.builtin   { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.builtin a { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.constant   { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.constant a { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.variable-name   { color: #a0522d;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.variable-name a { color: #a0522d;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.function-name   { color: #0000ff;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.function-name a { color: #0000ff;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.module   { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.module a { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.keyword   { color: #a020f0;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.keyword a { color: #a020f0;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.constructor   { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #000000;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.constructor a { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #000000;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.operator   { color: #a52a2a;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.operator a { color: #a52a2a;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.type   { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.type a { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.governing   { color: #000000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.governing a { color: #000000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.comment   { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.comment a { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
span.comment-delimiter   { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: none; }
span.comment-delimiter a { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #ffffff;  font-size: 10pt;  text-decoration: underline; }
 --></style>

    <script type="text/javascript"><!--
  // this function is needed to work around
  // a bug in IE related to element attributes
  function hasClass(obj)
  {
      var result = false;
      if (obj.getAttributeNode("class") != null)
      {
          result = obj.getAttributeNode("class").value;
      }
      return result;
  }

  function stripe(id)
  {
      // the flag we'll use to keep track of
      // whether the current row is odd or even
      var even = false;

      // if arguments are provided to specify the colors
      // of the even & odd rows, then use them;
      // otherwise use the following defaults:
      var evenColor = arguments[1] ? arguments[1] : "#fff";
      var oddColor  = arguments[2] ? arguments[2] : "#ddd";

      // obtain a reference to the desired table
      // if no such table exists, abort
      var table = document.getElementById(id);
      if (! table) { return; }

      // by definition, tables can have more than one tbody
      // element, so we'll have to get the list of child
      // &lt;tbody&gt;s
      var tbodies = table.getElementsByTagName("tbody");

      // and iterate through them...
      for (var h = 0; h < tbodies.length; h++)
      {
          // find all the &lt;tr&gt; elements...
          var trs = tbodies[h].getElementsByTagName("tr");

          // ... and iterate through them
          for (var i = 0; i < trs.length; i++)
          {
              // avoid rows that have a class attribute
              // or backgroundColor style
              if (! hasClass(trs[i]) &&
                  ! trs[i].style.backgroundColor)
              {
                  // get all the cells in this row...
                  var tds = trs[i].getElementsByTagName("td");

                  // and iterate through them...
                  for (var j = 0; j < tds.length; j++)
                  {
                      var mytd = tds[j];

                      // avoid cells that have a class attribute
                      // or backgroundColor style
                      if (! hasClass(mytd) &&
                          ! mytd.style.backgroundColor)
                      {
                          mytd.style.backgroundColor =
                            even ? evenColor : oddColor;
                      }
                  }
              }
              // flip from odd to even, or vice-versa
              even =  ! even;
          }
      }
  }

  function toggle_invis( name )
  {
      var filter =
        { acceptNode:
          function( node )
          { var classname = node.id;
            if( classname )
            { var classbase = classname.substr( 0, name.length );
              if( classbase == name ) { return NodeFilter.FILTER_ACCEPT; } }
            return NodeFilter.FILTER_SKIP; } };
      var walker = document.createTreeWalker( document.body           ,
                                              NodeFilter.SHOW_ELEMENT ,
                                              filter                  ,
                                              false                   );
      while( walker.nextNode() )
      {
          var e = walker.currentNode;
          if( e.style.display == "none" ) { e.style.display = "inline"; }
          else                            { e.style.display = "none";   }
      }
  }
--> </script>
  </head>
  <body onload="stripe('index'); return true;">

<pre><span class="comment-delimiter">(* </span><span class="comment">A linear partition of a key space; this is used in the B-tree to implement nodes. 


From a list r0 k0 r1 k1 ... kn rn+1, we have a partition of the space K into:

- below k0
- k0 &lt;= _ &lt; k1
- k1 &lt;= _ &lt; k2
- ...
- kn &lt;= _

And the corresponding map: fun k -&gt; if k &lt; k0 then r0 else ...

------------

Operations we need to support: 

- find(k); we also need to be able to retrieve the actual key that
  matched k (see below)
- add(intv,r): change the value for interval intv
- merge(intv1,intv2,r): for two adjacent intervals, merge (assuming at
  least one key remains)
- split(intv,r1,k1,r2): split the interval intv (delete old interval,
  add two new intervals)
  - refine_below(r0,k0): split Less_than(k) into Less_than(k0) and Between(k0,k)
  - refine_above(kn,rn): ditto, vice versa
- adjust_midpoint(intv1,intv2,r1,k1,r2)- for steal cases; equivalent
  to deleting two intvs then adding two
- get size, and split into two partitions (subject to some size
  constraints etc on each partition)

It may be simpler to implement these operations via conversion to
lists? But this seems a bit awful.

For the steal/merge-left cases, we need to be able to navigate to the
immediately-preceding interval. And similarly, we need to be able to
navigate to the immediately-following interval. Given an interval, the
immediately-following interval can be derived. However, for the
immediately preceeding interval, we probably have to maintain a &quot;pred&quot;
map. This could be done in-map (eg as extra info in the value
component of a map entry), or outside (as a separate map that is
updated independently). Alternatively, we could accept a &quot;key&quot; that is
semantically &quot;slightly less than&quot; some given key. This would allow to
locate the &quot;previous&quot; interval fairly directly.

At any rate, we probably need:

- next_intv(intv): intv option
- prev_intv(intv): intv option
</span><span class="comment-delimiter">*)</span>

<span class="comment-delimiter">(* </span><span class="comment">FIXME should be called &quot;interval&quot;? </span><span class="comment-delimiter">*)</span>
<span class="governing">type</span> <span class="type">'k intv</span> <span class="operator">=</span> 
  <span class="operator">|</span> <span class="constructor">Less_than</span> <span class="keyword">of</span> 'k  <span class="comment-delimiter">(* </span><span class="comment">lt </span><span class="comment-delimiter">*)</span>
  <span class="operator">|</span> <span class="constructor">Between</span> <span class="keyword">of</span> 'k <span class="operator">*</span> 'k  <span class="comment-delimiter">(* </span><span class="comment">k1 &lt;= _ &lt; k2 </span><span class="comment-delimiter">*)</span>
  <span class="operator">|</span> <span class="constructor">Greater_eq</span> <span class="keyword">of</span> 'k  <span class="comment-delimiter">(* </span><span class="comment">k1 &lt;= _ </span><span class="comment-delimiter">*)</span>

<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'r</span><span class="operator">)</span><span class="type"> lin_partition</span> <span class="operator">=</span> <span class="operator">(</span>'k intv<span class="operator">,</span> 'r<span class="operator">)</span> <span class="module">Tjr_polymap.</span>t

<span class="governing">let</span> <span class="governing">rec</span> <span class="function-name">key_compare</span><span class="variable-name"> k_cmp k1 k2</span> <span class="operator">=</span>
  <span class="keyword">match</span> k1<span class="operator">,</span>k2 <span class="keyword">with</span> 
  <span class="operator">|</span> <span class="constructor">Less_than</span> k1<span class="operator">,</span> <span class="constructor">Less_than</span> k2 <span class="operator">-&gt;</span>
    <span class="comment-delimiter">(* </span><span class="comment">there is only one &quot;less_than&quot; interval </span><span class="comment-delimiter">*)</span>
    <span class="keyword">assert</span><span class="operator">(</span>k_cmp k1 k2 <span class="operator">=</span> 0<span class="operator">);</span>
    0
  <span class="operator">|</span> <span class="constructor">Less_than</span> k1<span class="operator">,</span> <span class="constructor">Between</span> <span class="operator">(</span>k2<span class="operator">,</span>k3<span class="operator">)</span> <span class="operator">-&gt;</span> 
    <span class="comment-delimiter">(* </span><span class="comment">the less than interval is below all other intervals </span><span class="comment-delimiter">*)</span>
    <span class="keyword">assert</span> <span class="operator">(</span>k_cmp k1 k2 <span class="operator">&lt;=</span> 0<span class="operator">);</span>
    <span class="operator">-</span>1
  <span class="operator">|</span> <span class="constructor">Less_than</span> k1<span class="operator">,</span> <span class="constructor">Greater_eq</span> k2 <span class="operator">-&gt;</span> 
    <span class="keyword">assert</span> <span class="operator">(</span>k_cmp k1 k2 <span class="operator">&lt;=</span> 0<span class="operator">);</span>
    <span class="operator">-</span>1
  <span class="operator">|</span> <span class="constructor">Between</span> _<span class="operator">,</span> <span class="constructor">Less_than</span> _ <span class="operator">-&gt;</span> 
    1
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>k2<span class="operator">,</span>k3<span class="operator">),</span> <span class="constructor">Between</span><span class="operator">(</span>k4<span class="operator">,</span>k5<span class="operator">)</span> <span class="operator">-&gt;</span> 
    k_cmp k2 k4
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>k2<span class="operator">,</span>k3<span class="operator">),</span> <span class="constructor">Greater_eq</span> k4 <span class="operator">-&gt;</span> 
    <span class="keyword">assert</span><span class="operator">(</span>k_cmp k2 k4 <span class="operator">&lt;</span> 0<span class="operator">);</span>
    <span class="operator">-</span>1
  <span class="operator">|</span> <span class="constructor">Greater_eq</span> _<span class="operator">,</span> <span class="constructor">Less_than</span> _ 
  <span class="operator">|</span> <span class="constructor">Greater_eq</span> _<span class="operator">,</span> <span class="constructor">Between</span> _ <span class="operator">-&gt;</span> 
    1
  <span class="operator">|</span> <span class="constructor">Greater_eq</span> k1<span class="operator">,</span> <span class="constructor">Greater_eq</span> k2 <span class="operator">-&gt;</span> 
    <span class="keyword">assert</span> <span class="operator">(</span>k_cmp k1 k2 <span class="operator">=</span> 0<span class="operator">);</span>
    0

<span class="comment-delimiter">(* </span><span class="comment">lower/upper bounds </span><span class="comment-delimiter">*)</span>
<span class="governing">let</span> <span class="function-name">get_bound</span><span class="variable-name"> intv</span> <span class="operator">=</span> 
  <span class="keyword">match</span> intv <span class="keyword">with</span>
  <span class="operator">|</span> <span class="constructor">Less_than</span> k <span class="operator">-&gt;</span> <span class="operator">(</span><span class="constructor">None</span><span class="operator">,</span><span class="constructor">Some</span> k<span class="operator">)</span>
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>k1<span class="operator">,</span>k2<span class="operator">)</span> <span class="operator">-&gt;</span> <span class="operator">(</span><span class="constructor">Some</span> k1<span class="operator">,</span> <span class="constructor">Some</span> k2<span class="operator">)</span>
  <span class="operator">|</span> <span class="constructor">Greater_eq</span> k <span class="operator">-&gt;</span> <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">,</span> <span class="constructor">None</span><span class="operator">)</span>

<span class="governing">let</span> <span class="function-name">in_interval</span><span class="variable-name"> k_cmp k intv</span> <span class="operator">=</span> 
  <span class="governing">let</span> <span class="operator">(</span><span class="variable-name">l</span><span class="operator">,</span><span class="variable-name">u</span><span class="operator">)</span> <span class="operator">=</span> get_bound intv <span class="governing">in</span>
  <span class="operator">(</span><span class="keyword">match</span> l <span class="keyword">with</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constant">true</span> <span class="operator">|</span> <span class="constructor">Some</span> l <span class="operator">-&gt;</span> k_cmp l k <span class="operator">&lt;=</span> 0<span class="operator">)</span> <span class="operator">&amp;&amp;</span>
  <span class="operator">(</span><span class="keyword">match</span> u <span class="keyword">with</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constant">true</span> <span class="operator">|</span> <span class="constructor">Some</span> u <span class="operator">-&gt;</span> k_cmp k u <span class="operator">&lt;</span> 0<span class="operator">)</span>

<span class="comment-delimiter">(* </span><span class="comment">This is actually fundamental </span><span class="comment-delimiter">*)</span>
<span class="governing">let</span> <span class="function-name">get_midpoint_of_adjacent_intervals</span><span class="variable-name"> intv1 intv2</span> <span class="operator">=</span>
  <span class="keyword">match</span> intv1<span class="operator">,</span>intv2 <span class="keyword">with</span>
  <span class="operator">|</span> <span class="constructor">Less_than</span> k1<span class="operator">,</span> <span class="constructor">Between</span><span class="operator">(</span>k2<span class="operator">,</span>_<span class="operator">)</span>
  <span class="operator">|</span> <span class="constructor">Less_than</span> k1<span class="operator">,</span> <span class="constructor">Greater_eq</span><span class="operator">(</span>k2<span class="operator">)</span>
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>_<span class="operator">,</span>k1<span class="operator">),</span><span class="constructor">Between</span><span class="operator">(</span>k2<span class="operator">,</span>_<span class="operator">)</span>
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>_<span class="operator">,</span>k1<span class="operator">),</span><span class="constructor">Greater_eq</span><span class="operator">(</span>k2<span class="operator">)</span>
    <span class="keyword">when</span> k1 <span class="operator">=</span> k2 <span class="operator">-&gt;</span> <span class="comment-delimiter">(* </span><span class="comment">NOTE the when clause covers all the preceding patterns </span><span class="comment-delimiter">*)</span>
    <span class="constructor">Some</span> k1
  <span class="operator">|</span> _ <span class="operator">-&gt;</span> <span class="constructor">None</span>

<span class="governing">let</span> <span class="function-name">get_midpoint_of_adjacent_intervals</span><span class="variable-name"> intv1 intv2</span> <span class="operator">=</span>
  <span class="keyword">match</span> get_bound intv1<span class="operator">,</span>get_bound intv2 <span class="keyword">with</span>
  <span class="operator">|</span> <span class="operator">(</span>_<span class="operator">,</span><span class="constructor">Some</span> k1<span class="operator">),(</span><span class="constructor">Some</span> k2<span class="operator">,</span>_<span class="operator">)</span> <span class="keyword">when</span> k1<span class="operator">=</span>k2 <span class="operator">-&gt;</span> <span class="constructor">Some</span> k1
  <span class="operator">|</span> _ <span class="operator">-&gt;</span> <span class="constructor">None</span>


<span class="governing">let</span> <span class="function-name">adjacent</span><span class="variable-name"> intv1 intv2</span> <span class="operator">=</span>
  get_midpoint_of_adjacent_intervals intv1 intv2 <span class="operator">&lt;&gt;</span> <span class="constructor">None</span>

<span class="governing">let</span> <span class="function-name">merge_adjacent</span><span class="variable-name"> intv1 intv2</span> <span class="operator">=</span> 
  <span class="keyword">assert</span><span class="operator">(</span>adjacent intv1 intv2<span class="operator">);</span>
  <span class="keyword">match</span> intv1<span class="operator">,</span>intv2 <span class="keyword">with</span>
  <span class="operator">|</span> <span class="constructor">Less_than</span> k1<span class="operator">,</span> <span class="constructor">Between</span><span class="operator">(</span>k2<span class="operator">,</span>k3<span class="operator">)</span> <span class="operator">-&gt;</span> <span class="constructor">Less_than</span><span class="operator">(</span>k3<span class="operator">)</span>
  <span class="operator">|</span> <span class="constructor">Less_than</span> k1<span class="operator">,</span> <span class="constructor">Greater_eq</span><span class="operator">(</span>k2<span class="operator">)</span> <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="string">&quot;merge_adjacent: attempt to merge Less_than and Greater_eq&quot;</span>
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>k1<span class="operator">,</span>k2<span class="operator">),</span><span class="constructor">Between</span><span class="operator">(</span>_<span class="operator">,</span>k3<span class="operator">)</span> <span class="operator">-&gt;</span> <span class="constructor">Between</span><span class="operator">(</span>k1<span class="operator">,</span>k3<span class="operator">)</span>
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>k1<span class="operator">,</span>_<span class="operator">),</span><span class="constructor">Greater_eq</span><span class="operator">(</span>k2<span class="operator">)</span> <span class="operator">-&gt;</span> <span class="constructor">Greater_eq</span><span class="operator">(</span>k1<span class="operator">)</span>
  <span class="operator">|</span> _ <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="string">&quot;impossible, since adjacent intv1 intv2&quot;</span>

<span class="comment-delimiter">(* </span><span class="comment">NOTE k_cmp only necessary for asserts </span><span class="comment-delimiter">*)</span>
<span class="governing">let</span> <span class="function-name">split_intv</span><span class="variable-name"> k_cmp intv k</span> <span class="operator">=</span> 
  <span class="keyword">assert</span><span class="operator">(</span>in_interval k_cmp k intv<span class="operator">);</span>
  <span class="keyword">match</span> intv <span class="keyword">with</span> 
  <span class="operator">|</span> <span class="constructor">Less_than</span> k' <span class="operator">-&gt;</span> 
    <span class="keyword">assert</span><span class="operator">(</span>k_cmp k k' <span class="operator">&lt;</span> 0<span class="operator">);</span>
    <span class="operator">(</span><span class="constructor">Less_than</span> k<span class="operator">,</span><span class="constructor">Between</span><span class="operator">(</span>k<span class="operator">,</span>k'<span class="operator">))</span>
  <span class="operator">|</span> <span class="constructor">Between</span><span class="operator">(</span>k1<span class="operator">,</span>k2<span class="operator">)</span> <span class="operator">-&gt;</span> 
    <span class="keyword">assert</span><span class="operator">(</span>k_cmp k1 k <span class="operator">&lt;</span> 0<span class="operator">);</span>
    <span class="operator">(</span><span class="constructor">Between</span><span class="operator">(</span>k1<span class="operator">,</span>k<span class="operator">),</span><span class="constructor">Between</span><span class="operator">(</span>k<span class="operator">,</span>k2<span class="operator">))</span>
  <span class="operator">|</span> <span class="constructor">Greater_eq</span> k' <span class="operator">-&gt;</span> 
    <span class="keyword">assert</span><span class="operator">(</span>k_cmp k' k <span class="operator">&lt;</span> 0<span class="operator">);</span>
    <span class="constructor">Between</span><span class="operator">(</span>k'<span class="operator">,</span>k<span class="operator">),</span><span class="constructor">Greater_eq</span><span class="operator">(</span>k<span class="operator">)</span>
      

<span class="governing">module</span> <span class="module">IgnoreA</span><span class="operator">(</span>_<span class="operator">:</span><span class="governing">sig</span><span class="type"> </span><span class="governing">end</span><span class="operator">)</span> <span class="operator">=</span> <span class="governing">struct</span>
  <span class="governing">let</span> <span class="variable-name">examples</span> <span class="operator">=</span> <span class="operator">[</span><span class="constructor">Less_than</span> 0<span class="operator">;</span> <span class="constructor">Between</span><span class="operator">(</span>0<span class="operator">,</span>1<span class="operator">);</span> <span class="constructor">Between</span><span class="operator">(</span>1<span class="operator">,</span>2<span class="operator">);</span> <span class="constructor">Greater_eq</span><span class="operator">(</span>2<span class="operator">)]</span>

  <span class="governing">let</span> <span class="variable-name">pairs</span> <span class="operator">=</span> 
    examples <span class="operator">|&gt;</span> <span class="module">List.</span>map <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">x</span> <span class="operator">-&gt;</span> examples <span class="operator">|&gt;</span> <span class="module">List.</span>map <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">y</span> <span class="operator">-&gt;</span> <span class="operator">(</span>x<span class="operator">,</span>y<span class="operator">)))</span>
    <span class="operator">|&gt;</span> <span class="module">List.</span>concat

  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> 
    <span class="module">List.</span>map <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">x</span><span class="operator">,</span><span class="variable-name">y</span><span class="operator">)</span> <span class="operator">-&gt;</span> x<span class="operator">,</span>y<span class="operator">,</span>key_compare <span class="module">Tjr_int.</span>compare x y<span class="operator">)</span> pairs
    <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">x</span> <span class="operator">-&gt;</span> 
    <span class="keyword">assert</span><span class="operator">(</span>x<span class="operator">=</span><span class="operator">[(</span><span class="constructor">Less_than</span> 0<span class="operator">,</span> <span class="constructor">Less_than</span> 0<span class="operator">,</span> 0<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Less_than</span> 0<span class="operator">,</span> <span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> <span class="operator">-</span>1<span class="operator">);</span>
              <span class="operator">(</span><span class="constructor">Less_than</span> 0<span class="operator">,</span> <span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> <span class="operator">-</span>1<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Less_than</span> 0<span class="operator">,</span> <span class="constructor">Greater_eq</span> 2<span class="operator">,</span> <span class="operator">-</span>1<span class="operator">);</span>
              <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> <span class="constructor">Less_than</span> 0<span class="operator">,</span> 1<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> <span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> 0<span class="operator">);</span>
              <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> <span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> <span class="operator">-</span>1<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> <span class="constructor">Greater_eq</span> 2<span class="operator">,</span> <span class="operator">-</span>1<span class="operator">);</span>
              <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> <span class="constructor">Less_than</span> 0<span class="operator">,</span> 1<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> <span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> 1<span class="operator">);</span>
              <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> <span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> 0<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> <span class="constructor">Greater_eq</span> 2<span class="operator">,</span> <span class="operator">-</span>1<span class="operator">);</span>
              <span class="operator">(</span><span class="constructor">Greater_eq</span> 2<span class="operator">,</span> <span class="constructor">Less_than</span> 0<span class="operator">,</span> 1<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Greater_eq</span> 2<span class="operator">,</span> <span class="constructor">Between</span> <span class="operator">(</span>0<span class="operator">,</span> 1<span class="operator">),</span> 1<span class="operator">);</span>
              <span class="operator">(</span><span class="constructor">Greater_eq</span> 2<span class="operator">,</span> <span class="constructor">Between</span> <span class="operator">(</span>1<span class="operator">,</span> 2<span class="operator">),</span> 1<span class="operator">);</span> <span class="operator">(</span><span class="constructor">Greater_eq</span> 2<span class="operator">,</span> <span class="constructor">Greater_eq</span> 2<span class="operator">,</span> 0<span class="operator">)]</span>
          <span class="operator">);</span>
    x
<span class="tuareg-font-double-colon-face">;;</span>
<span class="governing">end</span>

<span class="governing">let</span> <span class="governing">rec</span> <span class="function-name">iter_opt</span><span class="variable-name"> f x</span> <span class="operator">=</span>
  <span class="keyword">match</span> f x <span class="keyword">with</span>
  <span class="operator">|</span> <span class="constructor">Some</span> x <span class="operator">-&gt;</span> iter_opt f x
  <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> x

<span class="comment-delimiter">(* </span><span class="comment">we require at least one key and two r </span><span class="comment-delimiter">*)</span>
<span class="governing">let</span> <span class="function-name">make_map</span><span class="variable-name"> k_cmp ks rs</span> <span class="operator">=</span>
  <span class="keyword">assert</span><span class="operator">(</span><span class="module">List.</span>length ks <span class="operator">&gt;=</span>1<span class="operator">);</span>
  <span class="keyword">assert</span><span class="operator">(</span><span class="module">List.</span>length ks <span class="operator">+</span>1 <span class="operator">=</span> <span class="module">List.</span>length rs<span class="operator">);</span>
  <span class="governing">let</span> <span class="variable-name">map</span> <span class="operator">=</span> <span class="module">Tjr_polymap.</span>empty <span class="operator">(</span>key_compare k_cmp<span class="operator">)</span> <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">map</span> <span class="operator">=</span> 
    <span class="comment-delimiter">(* </span><span class="comment">deal with &lt;k0 maps to r0 </span><span class="comment-delimiter">*)</span>
    <span class="governing">let</span> <span class="variable-name">k0</span><span class="operator">,</span><span class="variable-name">r0</span> <span class="operator">=</span> <span class="module">List.</span>hd ks<span class="operator">,</span><span class="module">List.</span>hd rs <span class="governing">in</span>
    <span class="module">Tjr_polymap.</span>add <span class="operator">(</span><span class="constructor">Less_than</span> k0<span class="operator">)</span> r0 map
  <span class="governing">in</span>
  <span class="comment-delimiter">(* </span><span class="comment">now do the &quot;betweens&quot; </span><span class="comment-delimiter">*)</span>
  iter_opt 
    <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">map</span><span class="operator">,</span><span class="variable-name">ks</span><span class="operator">,</span><span class="variable-name">rs</span><span class="operator">)</span> <span class="operator">-&gt;</span> 
       <span class="keyword">match</span> <span class="operator">(</span>ks<span class="operator">,</span>rs<span class="operator">)</span> <span class="keyword">with</span> 
       <span class="operator">|</span> k1<span class="operator">::</span>k2<span class="operator">::</span>_<span class="operator">,</span>r2<span class="operator">::</span>_ <span class="operator">-&gt;</span> 
         <span class="constructor">Some</span><span class="operator">(</span><span class="module">Tjr_polymap.</span>add <span class="operator">(</span><span class="constructor">Between</span><span class="operator">(</span>k1<span class="operator">,</span>k2<span class="operator">))</span> r2 map<span class="operator">,</span> <span class="module">List.</span>tl ks<span class="operator">,</span> <span class="module">List.</span>tl rs<span class="operator">)</span>
       <span class="operator">|</span> _ <span class="operator">-&gt;</span> <span class="constructor">None</span><span class="operator">)</span>
    <span class="operator">(</span>map<span class="operator">,</span>ks<span class="operator">,</span><span class="module">List.</span>tl rs<span class="operator">)</span>
  <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">map</span><span class="operator">,[</span><span class="variable-name">kn</span><span class="operator">],[</span><span class="variable-name">rn</span><span class="operator">])</span> <span class="operator">-&gt;</span> 
  <span class="module">Tjr_polymap.</span>add <span class="operator">(</span><span class="constructor">Greater_eq</span> kn<span class="operator">)</span> rn map  <span class="attribute">[@@ocaml.warning </span><span class="string">&quot;-8&quot;</span><span class="attribute">]</span>


<span class="comment-delimiter">(* </span><span class="comment">test ------------------------------------------------------------- </span><span class="comment-delimiter">*)</span>

<span class="governing">module</span> <span class="module">IgnoreB</span><span class="operator">(</span>_<span class="operator">:</span><span class="governing">sig</span><span class="type"> </span><span class="governing">end</span><span class="operator">)</span> <span class="operator">=</span> <span class="governing">struct</span>
  <span class="governing">let</span> <span class="variable-name">ex_map</span> <span class="operator">=</span> make_map <span class="module">Tjr_int.</span>compare <span class="operator">[</span>0<span class="operator">;</span>1<span class="operator">;</span>2<span class="operator">;</span>3<span class="operator">]</span> <span class="operator">[</span><span class="string">&quot;r0&quot;</span><span class="operator">;</span><span class="string">&quot;r1&quot;</span><span class="operator">;</span><span class="string">&quot;r2&quot;</span><span class="operator">;</span><span class="string">&quot;r3&quot;</span><span class="operator">;</span><span class="string">&quot;r4&quot;</span><span class="operator">]</span>

  <span class="governing">let</span> <span class="variable-name">ex_intvs</span> <span class="operator">=</span> <span class="operator">[</span><span class="constructor">Less_than</span> 0<span class="operator">;</span> <span class="constructor">Between</span><span class="operator">(</span>0<span class="operator">,</span>1<span class="operator">);</span> <span class="constructor">Between</span><span class="operator">(</span>1<span class="operator">,</span>2<span class="operator">);</span> <span class="constructor">Between</span><span class="operator">(</span>2<span class="operator">,</span>3<span class="operator">);</span> <span class="constructor">Greater_eq</span><span class="operator">(</span>3<span class="operator">)]</span>

  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> 
    ex_intvs 
    <span class="operator">|&gt;</span> <span class="module">List.</span>map <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">intv</span> <span class="operator">-&gt;</span> <span class="module">Tjr_polymap.</span>find intv ex_map<span class="operator">)</span>
    <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">x</span> <span class="operator">-&gt;</span>
    <span class="keyword">assert</span><span class="operator">(</span>x<span class="operator">=</span><span class="operator">[</span><span class="string">&quot;r0&quot;</span><span class="operator">;</span> <span class="string">&quot;r1&quot;</span><span class="operator">;</span> <span class="string">&quot;r2&quot;</span><span class="operator">;</span> <span class="string">&quot;r3&quot;</span><span class="operator">;</span> <span class="string">&quot;r4&quot;</span><span class="operator">]</span><span class="operator">);</span>
    x
  <span class="tuareg-font-double-colon-face">;;</span>
<span class="governing">end</span>


<span class="comment-delimiter">(* </span><span class="comment">predecessor / successor relationship ----------------------------- </span><span class="comment-delimiter">*)</span>

<span class="comment-delimiter">(* </span><span class="comment">maintain a set of pairs (pred,succ)? or two maps? let's maintain a
   single map for the time being, for predecessor

  but the map already has (essentially) this structure; even so,
   perhaps better to separate out </span><span class="comment-delimiter">*)</span>

<span class="comment-delimiter">(* </span><span class="comment">this assumes there is some underlying order, and we just track a finite subset of this order </span><span class="comment-delimiter">*)</span>
<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'t</span><span class="operator">)</span><span class="type"> pred_succ_ops</span> <span class="operator">=</span> <span class="operator">{</span>
  empty<span class="operator">:</span> unit <span class="operator">-&gt;</span> 't<span class="operator">;</span>
  get_pred<span class="operator">:</span> 'k <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 'k option <span class="operator">*</span> bool<span class="operator">;</span>  <span class="comment-delimiter">(* </span><span class="comment">bool indicates whether the key was in the set already </span><span class="comment-delimiter">*)</span>
  get_succ<span class="operator">:</span> 'k <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 'k option<span class="operator">;</span>
  get_intv<span class="operator">:</span> 'k <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 'k intv<span class="operator">;</span>
  insert<span class="operator">:</span> 'k <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 't<span class="operator">;</span>
  remove<span class="operator">:</span> 'k <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 't<span class="operator">;</span>
  elements<span class="operator">:</span> 't <span class="operator">-&gt;</span> 'k list<span class="operator">;</span>
<span class="operator">}</span>


<span class="comment-delimiter">(* </span><span class="comment">implement the above using a set </span><span class="comment-delimiter">*)</span>
<span class="governing">open </span><span class="module">Tjr_poly_set</span> 

<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'t</span><span class="operator">)</span><span class="type"> set_ops</span> <span class="operator">=</span> <span class="operator">(</span>'k<span class="operator">,</span>'t<span class="operator">)</span><span class="module">Tjr_poly_set.</span>set_ops

<span class="governing">let</span> <span class="function-name">dest_Some</span><span class="variable-name"> x</span> <span class="operator">=</span> <span class="keyword">match</span> x <span class="keyword">with</span> <span class="constructor">Some</span> x <span class="operator">-&gt;</span> x <span class="operator">|</span> _ <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="string">&quot;dest_Some&quot;</span>

<span class="comment-delimiter">(* </span><span class="comment">FIXME the use of split is rather inefficient FIXME what is the cost
   of the split operation? FIXME perhaps better to search with a
   special k-delta key to get pred etc. </span><span class="comment-delimiter">*)</span>
<span class="governing">let</span> <span class="function-name">make_pred_succ_ops</span><span class="variable-name"> set_ops</span> <span class="operator">=</span>
  <span class="governing">let</span> <span class="function-name">empty</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> set_ops.empty <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">get_pred</span><span class="variable-name"> k t</span> <span class="operator">=</span> set_ops.split k t <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">lower</span><span class="operator">,</span><span class="variable-name">present</span><span class="operator">,</span><span class="variable-name">_</span><span class="operator">)</span> <span class="operator">-&gt;</span> set_ops.max_elt_opt lower<span class="operator">,</span>present <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">get_succ</span><span class="variable-name"> k t</span> <span class="operator">=</span> set_ops.split k t <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">_</span><span class="operator">,</span><span class="variable-name">_</span><span class="operator">,</span><span class="variable-name">higher</span><span class="operator">)</span> <span class="operator">-&gt;</span> set_ops.min_elt_opt higher <span class="governing">i</span><span class="governing">n</span>
  <span class="governing">let</span> <span class="function-name">get_intv</span><span class="variable-name"> k t</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="operator">(</span><span class="variable-name">p</span><span class="operator">,</span><span class="variable-name">b</span><span class="operator">),</span><span class="variable-name">s</span> <span class="operator">=</span> get_pred k t<span class="operator">,</span> get_succ k t <span class="governing">in</span>
    <span class="keyword">match</span> b <span class="keyword">with</span>
    <span class="operator">|</span> <span class="constant">true</span> <span class="operator">-&gt;</span> <span class="operator">(</span>
        <span class="comment-delimiter">(* </span><span class="comment">k is present </span><span class="comment-delimiter">*)</span>
        <span class="keyword">match</span> s <span class="keyword">with</span>
        <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constructor">Greater_eq</span><span class="operator">(</span>k<span class="operator">)</span>
        <span class="operator">|</span> <span class="constructor">Some</span> k' <span class="operator">-&gt;</span> <span class="constructor">Between</span><span class="operator">(</span>k<span class="operator">,</span>k'<span class="operator">))</span>
    <span class="operator">|</span> <span class="constant">false</span> <span class="operator">-&gt;</span> <span class="operator">(</span>
        <span class="comment-delimiter">(* </span><span class="comment">k is not present </span><span class="comment-delimiter">*)</span>
        <span class="keyword">match</span> p <span class="keyword">with</span> 
        <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="operator">(</span>            
          <span class="keyword">assert</span><span class="operator">(</span>s <span class="operator">&lt;&gt;</span> <span class="constructor">None</span><span class="operator">);</span>
          <span class="constructor">Less_than</span><span class="operator">(</span>dest_Some s<span class="operator">))</span>
        <span class="operator">|</span> <span class="constructor">Some</span> k' <span class="operator">-&gt;</span> <span class="operator">(</span>
            <span class="keyword">match</span> s <span class="keyword">with</span>
            <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constructor">Greater_eq</span><span class="operator">(</span>k'<span class="operator">)</span>
            <span class="operator">|</span> <span class="constructor">Some</span> k'' <span class="operator">-&gt;</span> <span class="constructor">Between</span><span class="operator">(</span>k'<span class="operator">,</span>k''<span class="operator">)))</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">insert</span><span class="variable-name"> k t</span> <span class="operator">=</span> set_ops.add k t <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">remove</span><span class="variable-name"> k t</span> <span class="operator">=</span> set_ops.remove k t <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">elements</span><span class="variable-name"> t</span> <span class="operator">=</span> set_ops.elements t <span class="governing">in</span>
  <span class="operator">{</span> empty<span class="operator">;</span> get_pred<span class="operator">;</span> get_succ<span class="operator">;</span> get_intv<span class="operator">;</span> insert<span class="operator">;</span> remove<span class="operator">;</span> elements <span class="operator">}</span>

<span class="governing">let</span> <span class="variable-name">_</span><span class="operator">=</span>  make_pred_succ_ops


<span class="comment-delimiter">(* </span><span class="comment">example/test with ints ------------------------------------------- </span><span class="comment-delimiter">*)</span>

<span class="governing">module</span> <span class="module">IgnoreC</span><span class="operator">(</span>_<span class="operator">:</span><span class="governing">sig</span><span class="type"> </span><span class="governing">end</span><span class="operator">)</span> <span class="operator">=</span> <span class="governing">struct</span>

  <span class="governing">let</span> <span class="variable-name">set_ops</span> <span class="operator">=</span> <span class="module">Tjr_poly_set.</span>make_set_ops <span class="operator">(</span><span class="constructor">None</span><span class="operator">:</span><span class="module">Tjr_set.Int_set.</span>t option<span class="operator">)</span> <span class="operator">(</span><span class="module">Tjr_int.</span>compare<span class="operator">)</span>

  <span class="governing">let</span> <span class="variable-name">pred_succ_ops</span> <span class="operator">=</span> make_pred_succ_ops set_ops

  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="operator">{</span> empty<span class="operator">;</span> get_pred<span class="operator">;</span> get_succ<span class="operator">;</span> get_intv<span class="operator">;</span> insert<span class="operator">;</span> remove<span class="operator">;</span> elements <span class="operator">}</span> <span class="operator">=</span> pred_succ_ops <span class="governing">in</span>
    <span class="governing">let</span> <span class="function-name">i2s</span><span class="variable-name"> i</span> <span class="operator">=</span> <span class="keyword">match</span> i <span class="keyword">with</span>
      <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="string">&quot;-&quot;</span>
      <span class="operator">|</span> <span class="constructor">Some</span> i <span class="operator">-&gt;</span> string_of_int i
    <span class="governing">in</span>
    <span class="governing">let</span> <span class="function-name">print_state</span><span class="variable-name"> t</span> <span class="operator">=</span> 
      elements t <span class="operator">|&gt;</span> <span class="module">List.</span>iter <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">x</span> <span class="operator">-&gt;</span>
          <span class="module">Printf.</span>printf <span class="string">&quot;Elt %d: pred=%s; succ=%s\n&quot;</span> 
            x 
            <span class="operator">(</span>get_pred x t <span class="operator">|&gt;</span>fst<span class="operator">|&gt;</span>i2s<span class="operator">)</span> 
            <span class="operator">(</span>get_succ x t <span class="operator">|&gt;</span>i2s<span class="operator">))</span>
    <span class="governing">in</span>    
    iter_opt 
      <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">t</span><span class="operator">,</span><span class="variable-name">ops</span><span class="operator">)</span> <span class="operator">-&gt;</span> 
         <span class="keyword">match</span> ops <span class="keyword">with</span> 
         <span class="operator">|</span> <span class="operator">[]</span> <span class="operator">-&gt;</span> <span class="constructor">None</span>
         <span class="operator">|</span> op<span class="operator">::</span>ops <span class="operator">-&gt;</span> 
           <span class="governing">let</span> <span class="variable-name">t'</span> <span class="operator">=</span> op t <span class="governing">in</span>
           <span class="constructor">Some</span><span class="operator">(</span>t'<span class="operator">,</span>ops<span class="operator">))</span>
      <span class="operator">(</span>empty <span class="operator">(),</span>
       <span class="operator">[</span>insert 2<span class="operator">;</span>
        insert 4<span class="operator">;</span>
        insert 6<span class="operator">;</span>
        <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">t</span> <span class="operator">-&gt;</span> <span class="module">Printf.</span>printf <span class="string">&quot;%s\n&quot;</span> <span class="constant">__LOC__</span><span class="operator">;</span> print_state t<span class="operator">;</span> t<span class="operator">);</span>
        remove 4<span class="operator">;</span>
        <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">t</span> <span class="operator">-&gt;</span> <span class="module">Printf.</span>printf <span class="string">&quot;%s\n&quot;</span> <span class="constant">__LOC__</span><span class="operator">;</span> print_state t<span class="operator">;</span> t<span class="operator">)</span><span class="operator">;</span>
        remove 2<span class="operator">;</span>
        <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">t</span> <span class="operator">-&gt;</span> <span class="module">Printf.</span>printf <span class="string">&quot;%s\n&quot;</span> <span class="constant">__LOC__</span><span class="operator">;</span> print_state t<span class="operator">;</span> t<span class="operator">)</span><span class="operator">;</span>
        insert 10<span class="operator">;</span>
        insert 11<span class="operator">;</span>
        remove 10<span class="operator">;</span>
        <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">t</span> <span class="operator">-&gt;</span> <span class="module">Printf.</span>printf <span class="string">&quot;%s\n&quot;</span> <span class="constant">__LOC__</span><span class="operator">;</span> print_state t<span class="operator">;</span> t<span class="operator">)</span><span class="operator">;</span>
       <span class="operator">])</span>
<span class="tuareg-font-double-colon-face">;;</span>

<span class="governing">end</span>


<span class="comment-delimiter">(* </span><span class="comment">At this point, we have:

- a map from intervals
- a pred/succ mapping

So, given a key k, we can get the range k1 &lt;= k &lt; k2 (or other), and get the corresponding r.

Operations:

| find(k)                               | get intv for k; lookup intv                       | 
| add(intv,r)                           | replace intv binding in map                       | 
| merge_adjacent(intv1,intv2,r)                  | remove intvs; add(intv,r); adjust pred/succ       | 
| split(intv,r1,k1,r2)                  | remove intv; add new intvs; adjust pred/succ      | 
| adjust_midpoint(intv1,intv2,r1,k1,r2) | remove two intvs; add two intvs; adjust pred/succ | 
| get size                              | pred/succ.elements gives size                     | 
| split into two                        | map has a split operation, and also set; use these to implement split | 

</span><span class="comment-delimiter">*)</span>

<span class="comment-delimiter">(* </span><span class="comment">Use the term &quot;keyspace&quot;; FIXME better options? </span><span class="comment-delimiter">*)</span>
<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'r</span><span class="operator">,</span><span class="type">'t</span><span class="operator">)</span><span class="type"> keyspace_ops</span> <span class="operator">=</span> <span class="operator">{</span>
  find<span class="operator">:</span> 'k <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 'r<span class="operator">;</span> <span class="comment-delimiter">(* </span><span class="comment">NOTE total </span><span class="comment-delimiter">*)</span>
  add<span class="operator">:</span> 'k intv <span class="operator">-&gt;</span> 'r <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 't<span class="operator">;</span>
  ks_merge_adjacent<span class="operator">:</span> 'k intv <span class="operator">-&gt;</span> 'k intv <span class="operator">-&gt;</span> 'r <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 't<span class="operator">;</span>
  ks_split_intv<span class="operator">:</span> 'k intv <span class="operator">-&gt;</span> 'r<span class="operator">*</span>'k<span class="operator">*</span>'r <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 't<span class="operator">;</span>
  adjust_midpoint<span class="operator">:</span> 'k intv <span class="operator">-&gt;</span> 'k intv <span class="operator">-&gt;</span> 'r<span class="operator">*</span>'k<span class="operator">*</span>'r <span class="operator">-&gt;</span> 't <span class="operator">-&gt;</span> 't<span class="operator">;</span>
<span class="comment-delimiter">(*  </span><span class="comment">k_size: 't -&gt; int;
  split_keyspace: 't -&gt; 't * 'k * 't; </span><span class="comment-delimiter">*)</span>
<span class="operator">}</span>

<span class="governing">type</span> <span class="operator">(</span><span class="type">'a</span><span class="operator">,</span><span class="type">'b</span><span class="operator">)</span><span class="type"> pair</span> <span class="operator">=</span> <span class="operator">{</span>
  lin_partition<span class="operator">:</span> 'a<span class="operator">;</span>
  pred_succ<span class="operator">:</span> 'b
<span class="operator">}</span>

<span class="governing">let</span> <span class="function-name">make_keyspace_ops</span><span class="variable-name"> </span><span class="operator">(</span><span class="keyword">type</span><span class="variable-name"> </span><span class="type">k</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~(</span><span class="variable-name">k_cmp</span><span class="operator">:</span><span class="type">k </span><span class="operator">-&gt;</span><span class="type"> k </span><span class="operator">-&gt;</span><span class="type"> int</span><span class="operator">)</span><span class="variable-name"> </span><span class="label">~lin_partition</span><span class="operator">:</span><span class="variable-name">linp </span><span class="label">~pred_succ_ops</span><span class="operator">:</span><span class="variable-name">ps_ops</span> <span class="operator">=</span>
  <span class="comment-delimiter">(* </span><span class="comment">implement using a pair of a lin partition and a pred/succ set </span><span class="comment-delimiter">*)</span>
  <span class="governing">let</span> <span class="function-name">find</span><span class="variable-name"> k t</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="variable-name">intv</span> <span class="operator">=</span> ps_ops.get_intv k t.pred_succ <span class="governing">in</span>
    <span class="module">Tjr_polymap.</span>find intv t.lin_partition
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">add</span><span class="variable-name"> intv r t</span> <span class="operator">=</span>
    <span class="operator">{</span>t <span class="keyword">with</span> lin_partition<span class="operator">=</span><span class="module">Tjr_polymap.</span>add intv r t.lin_partition<span class="operator">}</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">ks_merge_adjacent</span><span class="variable-name"> intv1 intv2 r t</span> <span class="operator">=</span>
    <span class="keyword">assert</span><span class="operator">(</span>adjacent intv1 intv2<span class="operator">);</span>
    <span class="governing">let</span> <span class="variable-name">intv</span> <span class="operator">=</span> merge_adjacent intv1 intv2 <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">lin_partition</span> <span class="operator">=</span>
      t.lin_partition
      <span class="operator">|&gt;</span> <span class="module">Tjr_polymap.</span>remove intv1
      <span class="operator">|&gt;</span> <span class="module">Tjr_polymap.</span>remove intv2
      <span class="operator">|&gt;</span> <span class="module">Tjr_polymap.</span>add intv r
    <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">pred_succ</span> <span class="operator">=</span>
      <span class="comment-delimiter">(* </span><span class="comment">let midpt of intv1 intv2 be k; we just have to delete k </span><span class="comment-delimiter">*)</span>
      <span class="governing">let</span> <span class="variable-name">k</span> <span class="operator">=</span> get_midpoint_of_adjacent_intervals intv1 intv2 <span class="governing">in</span>
      t.pred_succ 
      <span class="operator">|&gt;</span> ps_ops.remove k
    <span class="governing">in</span>
    <span class="operator">{</span> lin_partition<span class="operator">;</span> pred_succ <span class="operator">}</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> ks_merge_adjacent <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">ks_split_intv</span><span class="variable-name"> intv </span><span class="operator">(</span><span class="variable-name">r1</span><span class="operator">,</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">r2</span><span class="operator">)</span><span class="variable-name"> t</span> <span class="operator">=</span>
    <span class="governing">let</span> <span class="variable-name">intv1</span><span class="operator">,</span><span class="variable-name">intv2</span> <span class="operator">=</span> split_intv k_cmp intv k <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">lin_partition</span> <span class="operator">=</span>
      t.lin_partition
      <span class="operator">|&gt;</span> <span class="module">Tjr_polymap.</span>remove intv
      <span class="operator">|&gt;</span> <span class="module">Tjr_polymap.</span>add intv1 r1
      <span class="operator">|&gt;</span> <span class="module">Tjr_polymap.</span>add intv2 r2
    <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">pred_succ</span> <span class="operator">=</span>
      <span class="comment-delimiter">(* </span><span class="comment">just add k </span><span class="comment-delimiter">*)</span>
      t.pred_succ <span class="operator">|&gt;</span> ps_ops.insert <span class="merlin-compilation-error-face-0000">k</span>
    <span class="governing">in</span>
    <span class="operator">{</span> lin_partition<span class="operator">;</span> pred_succ <span class="operator">}</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> ks_split_intv <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">adjust_midpoint</span><span class="variable-name"> intv1 intv2 </span><span class="operator">(</span><span class="variable-name">r1</span><span class="operator">,</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">r2</span><span class="operator">)</span><span class="variable-name"> t</span> <span class="operator">=</span>
    <span class="governing">let</span> <span class="variable-name">dummy_r</span> <span class="operator">=</span> r1 <span class="governing">in</span>
    t
    <span class="operator">|&gt;</span> ks_merge_adjacent intv1 intv2 dummy_r
    <span class="comment-delimiter">(* </span><span class="comment">|&gt; ks_split_intv (merge_adjacent intv1 intv2) (r1,k,r2) </span><span class="comment-delimiter">*)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> adjust_midpoint <span class="governing">in</span>
  <span class="keyword">fun</span> <span class="variable-name">k</span> <span class="operator">-&gt;</span> k <span class="operator">~</span>find <span class="operator">~</span>add <span class="operator">~</span>ks_merge_adjacent <span class="operator">~</span>ks_split_intv <span class="operator">~</span>adjust_midpoint
  <span class="comment-delimiter">(* </span><span class="comment">{ find; add; ks_merge_adjacent; ks_split_intv; adjust_midpoint } </span><span class="comment-delimiter">*)</span>

<span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> make_keyspace_ops
      
</pre>

 </body>
</html>
